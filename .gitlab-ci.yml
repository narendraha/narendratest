stages:
  - check-package-json
 
check-package-json:
  stage: check-package-json
  before_script:
    - apt-get update && apt-get install -y jq
  script:
    |
      git fetch origin $CI_COMMIT_BRANCH
      git checkout $CI_COMMIT_BRANCH
      PREVIOUS_PACKAGE_JSON=$(git show origin/$CI_COMMIT_BRANCH~1:package.json)
      CURRENT_PACKAGE_JSON=$(cat package.json)
      PREVIOUS_DEPS=$(echo "$PREVIOUS_PACKAGE_JSON" | jq -r '.dependencies | keys[]')
      CURRENT_DEPS=$(echo "$CURRENT_PACKAGE_JSON" | jq -r '.dependencies | keys[]')
 
      for dep in $PREVIOUS_DEPS; do
        if ! echo "$CURRENT_DEPS" | grep -qw "$dep"; then
          echo "$dep is missing in the package.json file "
        fi
        exit 1
      done
 
      NEW_DEPS=$(comm -13 <(echo "$PREVIOUS_DEPS" | sort) <(echo "$CURRENT_DEPS" | sort))
      if [ -n "$NEW_DEPS" ]; then
        echo "New dependencies added:"
        for dep in $NEW_DEPS; do
          echo "- $dep"
        done
      else
        echo "No modifications have been made to package.json"
      fi